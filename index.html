<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Battleship</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <style>
    table {
      display: inline-block;
    }
    table,
    th,
    td {
      border: 1px solid black;
    }
    #selected {
      background-color: coral;
    }
  </style>
  <script>
    const toPlace = [
      { name: "carrier", length: 5 },
      { name: "battleship", length: 5 },
    ];

    let player = {
      placed: 0,
      placement: {
        A: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        B: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        C: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        D: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        E: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        F: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        G: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        H: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        I: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        J: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      },
    };
    let ai = {
      placed: 0,
      placement: {
        A: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        B: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        C: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        D: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        E: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        F: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        G: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        H: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        I: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        J: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      },
    };

    const randomSelection = () => {
      return Math.random() >= 0.5;
    };

    const generateStart = () => {
      const columns = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"];
      const col = columns[Math.floor(Math.random() * columns.length)];
      const row = Math.floor(Math.random() * 9);
      return { col, row };
    };

    const placeAi = () => {
      const columns = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"];
      for (const ship of toPlace) {
        const start = generateStart();
        const horizontal = randomSelection();
        console.log("start", start);
        if (horizontal) {
          const index = columns.indexOf(start.col);
          if (index + ship.length < 10) {
            for (let i = 1; i < ship.length; i++) {
              const next = columns[index + i];
              const row = start.row;
              console.log("horizontal forward ABC", { col: next, row });
            }
          } else {
            for (let i = 1; i < ship.length; i++) {
              const next = columns[index - i];
              const row = start.row;
              console.log("horizontal backward BCA", { col: next, row });
            }
          }
        } else {
          const row = start.row;
          if (row + ship.length < 10) {
            for (let i = 1; i < ship.length; i++) {
              const col = start.col;
              const next = start.row + i;
              console.log("vertical increase 123", { col, row: next });
            }
          } else {
            for (let i = 1; i < ship.length; i++) {
              const col = start.col;
              const next = start.row - i;
              console.log("vertical decrease 321", { col, row: next });
            }
          }
        }
      }
    };

    const game = () => {
      placeAi();
      const firstTurn = randomSelection();
      $("#log").append(
        `<p>Game started. ${firstTurn ? "player" : "comp"} has first turn</p>`
      );
    };

    $(document).ready(function () {
      for (let i = 1; i <= 10; i++) {
        $("tbody").append(`<tr>
              <th>${i}</th>
              <td id=A${i}></td>
              <td id=B${i}></td>
              <td id=C${i}></td>
              <td id=D${i}></td>
              <td id=E${i}></td>
              <td id=F${i}></td>
              <td id=G${i}></td>
              <td id=H${i}></td>
              <td id=I${i}></td>
              <td id=J${i}></td>
            </tr>`);
      }
    });

    async function place(ship) {
      return new Promise(function (resolve, reject) {
        $("#log").append(`<p>Place ${ship.name}. Length is ${ship.length}</p>`);
        let counter = 0;
        $("#player tr td").click(function (event) {
          $(this).css("background-color", "grey");
          let id = $(this).attr("id");
          let col = id.slice(0, 1);
          let row = id.slice(1) - 1;
          console.log(col, row);
          player.placement[col][row] = 1;
          counter++;
          console.log("clicked: ", counter, ship.name);
          if (counter === ship.length) {
            player.placed++;
            return resolve();
          }
        });
      }).finally(() => {
        counter = 0;
        ship = {};
      });
    }
    $(document).ready(function () {
      $("#start").click(async function (event) {
        $("#log").append("<p>Game Initiated. Place your ships.</p>");
        $(this).html("Waiting for ship placement").attr("disabled", "disabled");
        for (const ship of toPlace) {
          // console.log(ship);
          await place(ship);
        }
        if (toPlace.length === player.placed) {
          $("#log").append(`All ships placed.`);
          $(this).html("Ready to play").prop("disabled", false);
          game();
        }
      });
    });
  </script>
  <body>
    <table id="player">
      Player
      <thead>
        <tr>
          <th></th>
          <th>A</th>
          <th>B</th>
          <th>C</th>
          <th>D</th>
          <th>E</th>
          <th>F</th>
          <th>G</th>
          <th>H</th>
          <th>I</th>
          <th>J</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <table id="ai">
      Computer
      <thead>
        <tr>
          <th></th>
          <th>A</th>
          <th>B</th>
          <th>C</th>
          <th>D</th>
          <th>E</th>
          <th>F</th>
          <th>G</th>
          <th>H</th>
          <th>I</th>
          <th>J</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="start">Start Game</button>
    <div>
      <h3>Game Log</h3>
      <div id="log">
        <p>welcome.</p>
      </div>
    </div>
  </body>
</html>
